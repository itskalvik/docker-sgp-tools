<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ROS2 - BlueOS</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
        background: #1e1e1e;
        color: #ffffff;
        overflow: hidden;
        height: 100vh;
      }

      .header {
        background: #2d2d2d;
        padding: 0px;
        border-bottom: 1px solid #404040;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .title {
        font-size: 18px;
        font-weight: bold;
      }

      .controls {
        display: flex;
        gap: 10px;
      }

      .btn {
        background: #007acc;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: background 0.2s;
      }

      .btn:hover {
        background: #005a9e;
      }

      .btn.danger {
        background: #d73a49;
      }

      .btn.danger:hover {
        background: #b31d28;
      }

      .tab-container {
        background: #2d2d2d;
        border-bottom: 1px solid #404040;
        display: flex;
        align-items: center;
        padding: 0 10px;
      }

      .tab {
        background: #404040;
        color: #cccccc;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        font-size: 12px;
        border-radius: 4px 4px 0 0;
        margin-right: 2px;
        transition: all 0.2s;
        position: relative;
      }

      .tab.active {
        background: #1e1e1e;
        color: #ffffff;
      }

      .tab:hover {
        background: #505050;
      }

      .tab-close {
        margin-left: 8px;
        background: #666;
        color: white;
        border: none;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        cursor: pointer;
        font-size: 10px;
        line-height: 1;
      }

      .tab-close:hover {
        background: #ff4444;
      }

      .tab-title {
        display: inline-block;
        max-width: 120px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .new-tab {
        background: transparent;
        color: #007acc;
        border: 1px dashed #007acc;
        padding: 10px 15px;
        margin-left: 10px;
      }

      .new-tab:hover {
        background: #007acc;
        color: white;
      }

      .terminal-container {
        height: calc(100vh - 65px);
        position: relative;
      }

      .terminal-frame {
        width: 100%;
        height: 100%;
        border: none;
        background: #1e1e1e;
      }

      .terminal-frame.hidden {
        display: none;
      }

      .status-bar {
        background: #2d2d2d;
        padding: 5px 10px;
        border-top: 1px solid #404040;
        font-size: 11px;
        color: #cccccc;
        display: flex;
        justify-content: space-between;
      }

      .status-item {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #666;
      }

      .status-indicator.connected {
        background: #28a745;
      }

      .status-indicator.disconnected {
        background: #dc3545;
      }

      .context-menu {
        position: fixed;
        background: #2d2d2d;
        border: 1px solid #404040;
        border-radius: 4px;
        padding: 5px 0;
        z-index: 1000;
        display: none;
      }

      .context-menu-item {
        padding: 8px 15px;
        cursor: pointer;
        font-size: 12px;
        transition: background 0.2s;
      }

      .context-menu-item:hover {
        background: #404040;
      }

      .context-menu-separator {
        height: 1px;
        background: #404040;
        margin: 5px 0;
      }

      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 10px 20px;
        border-radius: 4px;
        z-index: 1001;
        display: none;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #007acc;
        font-size: 16px;
      }

      .spinner {
        border: 2px solid #404040;
        border-top: 2px solid #007acc;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="tab-container" id="tabContainer">
        <!-- Tabs will be created here -->
        <button class="tab new-tab" onclick="terminal.createNewTab()">
          + New Tab
        </button>
      </div>
      <div class="controls">
        <button class="btn" onclick="reloadActiveTerminal()">üîÑ Reload</button>
        <button class="btn danger" onclick="closeAllTabs()">
          ‚ùå Close All
        </button>
      </div>
    </div>

    <div class="terminal-container" id="terminalContainer">
      <div class="loading" id="loading">
        <div class="spinner"></div>
        Loading terminal...
      </div>
      <!-- Terminal frames will be created here -->
    </div>

    <div class="status-bar">
      <div class="status-item">
        <div class="status-indicator" id="connectionStatus"></div>
        <span id="connectionText">Connecting...</span>
      </div>
      <div class="status-item">
        <span id="activeTabInfo">No tabs</span>
      </div>
      <div class="status-item">
        <span id="timestamp"></span>
      </div>
    </div>

    <div class="context-menu" id="contextMenu">
      <div class="context-menu-item" onclick="reloadActiveTerminal()">
        Reload
      </div>
      <div class="context-menu-item" onclick="terminal.renameActiveTab()">
        Rename Tab
      </div>
      <div class="context-menu-separator"></div>
      <div class="context-menu-item" onclick="closeActiveTab()">Close Tab</div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
      class AdvancedTerminal {
        constructor() {
          this.tabs = [];
          this.activeTabIndex = -1;
          this.tabCounter = 0;
          this.init();
        }

        init() {
          this.setupEventListeners();
          this.updateTimestamp();
          this.createNewTab();
          setInterval(() => this.updateTimestamp(), 1000);
        }

        setupEventListeners() {
          document.addEventListener("click", (e) => {
            if (!e.target.closest("#contextMenu")) {
              this.hideContextMenu();
            }
          });

          document.addEventListener("keydown", (e) => {
            if (e.ctrlKey || e.metaKey) {
              switch (e.key) {
                case "t":
                  e.preventDefault();
                  this.createNewTab();
                  break;
                case "w":
                  e.preventDefault();
                  this.closeActiveTab();
                  break;
              }
            }
          });
        }

        createNewTab(title = null) {
          const tabId = `tab-${++this.tabCounter}`;
          const tabTitle = title || `Terminal ${this.tabCounter}`;

          const tab = {
            id: tabId,
            title: tabTitle,
            frame: null,
            connected: false,
          };

          this.tabs.push(tab);
          this.createTabElement(tab);
          this.createTerminalFrame(tab);
          this.switchToTab(this.tabs.length - 1);

          return tab;
        }

        createTabElement(tab) {
          const tabContainer = document.getElementById("tabContainer");
          const newTabBtn = tabContainer.querySelector(".new-tab");

          const tabElement = document.createElement("button");
          tabElement.className = "tab";
          tabElement.setAttribute("data-tab-id", tab.id);
          tabElement.innerHTML = `
                    <span class="tab-title">${tab.title}</span>
                    <button class="tab-close" onclick="terminal.closeTab('${tab.id}')">√ó</button>
                `;
          tabElement.onclick = () =>
            this.switchToTab(this.tabs.findIndex((t) => t.id === tab.id));

          // Add double-click to rename functionality
          tabElement.ondblclick = (e) => {
            e.stopPropagation();
            this.renameTab(tab.id);
          };

          tabContainer.insertBefore(tabElement, newTabBtn);
        }

        createTerminalFrame(tab) {
          const container = document.getElementById("terminalContainer");
          const loading = document.getElementById("loading");

          const frame = document.createElement("iframe");
          frame.className = "terminal-frame hidden";
          frame.src = "/ttyd/";
          frame.id = tab.id;

          frame.onload = () => {
            tab.connected = true;
            this.updateConnectionStatus();
            loading.style.display = "none";
          };

          frame.onerror = () => {
            tab.connected = false;
            this.updateConnectionStatus();
            this.showToast("Failed to load terminal", "error");
          };

          container.appendChild(frame);
          tab.frame = frame;
        }

        switchToTab(index) {
          if (index < 0 || index >= this.tabs.length) return;

          // Hide all frames
          document.querySelectorAll(".terminal-frame").forEach((frame) => {
            frame.classList.add("hidden");
          });

          // Remove active class from all tabs
          document.querySelectorAll(".tab").forEach((tab) => {
            tab.classList.remove("active");
          });

          // Show selected frame and tab
          const tab = this.tabs[index];
          if (tab.frame) {
            tab.frame.classList.remove("hidden");
          }

          const tabElement = document.querySelector(
            `[data-tab-id="${tab.id}"]`
          );
          if (tabElement) {
            tabElement.classList.add("active");
          }

          this.activeTabIndex = index;
          this.updateActiveTabInfo();
        }

        closeTab(tabId) {
          const index = this.tabs.findIndex((tab) => tab.id === tabId);
          if (index === -1) return;

          const tab = this.tabs[index];

          // Remove frame
          if (tab.frame) {
            tab.frame.remove();
          }

          // Remove tab element
          const tabElement = document.querySelector(`[data-tab-id="${tabId}"]`);
          if (tabElement) {
            tabElement.remove();
          }

          // Remove from tabs array
          this.tabs.splice(index, 1);

          // Switch to another tab if needed
          if (this.tabs.length === 0) {
            this.createNewTab();
          } else if (this.activeTabIndex >= this.tabs.length) {
            this.switchToTab(this.tabs.length - 1);
          } else if (this.activeTabIndex === index) {
            this.switchToTab(Math.max(0, index - 1));
          }

          this.updateActiveTabInfo();
        }

        closeActiveTab() {
          if (
            this.activeTabIndex >= 0 &&
            this.activeTabIndex < this.tabs.length
          ) {
            this.closeTab(this.tabs[this.activeTabIndex].id);
          }
        }

        closeAllTabs() {
          if (confirm("Are you sure you want to close all tabs?")) {
            this.tabs.forEach((tab) => {
              if (tab.frame) {
                tab.frame.remove();
              }
            });
            this.tabs = [];
            this.tabCounter = 0
            document
              .querySelectorAll(".tab:not(.new-tab)")
              .forEach((tab) => tab.remove());
            this.createNewTab();
          }
        }

        reloadActiveTerminal() {
          if (
            this.activeTabIndex >= 0 &&
            this.activeTabIndex < this.tabs.length
          ) {
            const tab = this.tabs[this.activeTabIndex];
            if (tab.frame) {
              tab.frame.src = tab.frame.src;
              this.showToast("Terminal reloaded");
            }
          }
        }

        updateConnectionStatus() {
          const statusIndicator = document.getElementById("connectionStatus");
          const statusText = document.getElementById("connectionText");

          const connectedTabs = this.tabs.filter((tab) => tab.connected).length;
          const totalTabs = this.tabs.length;

          if (totalTabs === 0) {
            statusIndicator.className = "status-indicator disconnected";
            statusText.textContent = "No tabs";
          } else if (connectedTabs === totalTabs) {
            statusIndicator.className = "status-indicator connected";
            statusText.textContent = `Connected (${connectedTabs}/${totalTabs})`;
          } else {
            statusIndicator.className = "status-indicator";
            statusText.textContent = `Connecting (${connectedTabs}/${totalTabs})`;
          }
        }

        updateActiveTabInfo() {
          const info = document.getElementById("activeTabInfo");
          if (
            this.activeTabIndex >= 0 &&
            this.activeTabIndex < this.tabs.length
          ) {
            const tab = this.tabs[this.activeTabIndex];
            info.textContent = `Active: ${tab.title}`;
          } else {
            info.textContent = "No active tab";
          }
        }

        updateTimestamp() {
          const timestamp = document.getElementById("timestamp");
          timestamp.textContent = new Date().toLocaleTimeString();
        }

        showToast(message, type = "success") {
          const toast = document.getElementById("toast");
          toast.textContent = message;
          toast.style.background = type === "error" ? "#dc3545" : "#28a745";
          toast.style.display = "block";

          setTimeout(() => {
            toast.style.display = "none";
          }, 3000);
        }

        hideContextMenu() {
          document.getElementById("contextMenu").style.display = "none";
        }

        renameTab(tabId) {
          const tab = this.tabs.find((t) => t.id === tabId);
          if (!tab) return;

          const newTitle = prompt("Enter new tab title:", tab.title);
          if (newTitle && newTitle.trim() !== "") {
            tab.title = newTitle.trim();
            const tabElement = document.querySelector(
              `[data-tab-id="${tabId}"]`
            );
            if (tabElement) {
              tabElement.querySelector(".tab-title").textContent = tab.title;
            }
            this.showToast(`Tab renamed to "${tab.title}"`);
          }
        }

        renameActiveTab() {
          if (
            this.activeTabIndex >= 0 &&
            this.activeTabIndex < this.tabs.length
          ) {
            this.renameTab(this.tabs[this.activeTabIndex].id);
          }
        }
      }

      // Global functions for button onclick handlers
      let terminal;

      function reloadActiveTerminal() {
        terminal.reloadActiveTerminal();
      }

      function closeActiveTab() {
        terminal.closeActiveTab();
      }

      function closeAllTabs() {
        terminal.closeAllTabs();
      }

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", () => {
        terminal = new AdvancedTerminal();
      });
    </script>
  </body>
</html>
